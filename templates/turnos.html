{% extends "base.html" %}
{% block content %}

<div class="flex items-center justify-between mb-3">
  <div>
    <div class="text-zinc-400 text-[11px] tracking-widest mb-1">AGENDA</div>
    <h2 class="text-lg font-semibold">Turnos</h2>
  </div>

  <a href="/turnos/nuevo?date_str={{ selected_date }}"
     class="px-4 py-2 rounded-2xl font-semibold text-zinc-900 text-sm"
     style="background: var(--gold);">
     + Agendar
  </a>
</div>

<div class="mb-4">
  <button type="button" id="openCalendar"
  class="w-full px-4 py-3 rounded-2xl bg-zinc-900/60 border border-zinc-700 text-sm">
  <div class="flex items-center justify-between">
    <span id="dayName" class="font-semibold text-zinc-200 uppercase tracking-wide">
      —
    </span>
    <span id="dayDate" class="text-zinc-400">
      —
    </span>
  </div>
</button>

  <div id="calendarContainer" class="hidden mt-2"></div>
</div>

<div class="rounded-3xl border border-zinc-800 bg-white/5 backdrop-blur-xl overflow-hidden">
  {% for row in grid %}
    {% if row.state == "free" %}
      <a href="/turnos/nuevo?date_str={{ selected_date }}&time_str={{ row.time }}"
         class="flex items-center justify-between px-4 py-3 border-b border-zinc-800">
        <div class="text-sm text-zinc-300 font-semibold">{{ row.time }} HS</div>
        <div class="text-sm font-semibold text-green-400">LIBRE</div>
      </a>

    {% elif row.state == "blocked" %}
      <div class="flex items-center justify-between px-4 py-3 border-b border-zinc-800 bg-red-600/20">
        <div class="text-sm text-zinc-200 font-semibold">{{ row.time }} HS</div>
        <div class="text-sm font-semibold text-red-300">No disponible</div>
      </div>

    {% elif row.state == "occupied" %}
      <div class="flex items-center justify-between gap-3 px-4 py-3 border-b border-zinc-800 bg-zinc-950/30">
        <!-- IZQUIERDA: info (nunca se pisa) -->
        <a href="/turnos/{{ row.id }}/editar" class="min-w-0 flex-1">
          <div class="text-sm text-zinc-200 font-semibold">{{ row.time }} HS</div>

          <div class="text-sm text-white mt-1 truncate">
            {{ row.client }} ·
            <span class="font-semibold" style="color: {{ row.color }};">
              {{ row.specialty }}
            </span>

            {% if row.deposit_paid %}
              <span class="font-semibold" style="color:#38bdf8;"> · Seña ${{ row.deposit_amount }}</span>
            {% endif %}
          </div>
        </a>

        <!-- DERECHA: WhatsApp (siempre al extremo) -->
        <div class="shrink-0">
          <a href="/turnos/{{ row.id }}/whatsapp"
             class="relative w-10 h-10 rounded-2xl border border-zinc-800 bg-zinc-900/60 flex items-center justify-center hover:opacity-90"
             title="Enviar recordatorio por WhatsApp">
            <!-- Icono WhatsApp -->
            <svg width="20" height="20" viewBox="0 0 32 32" fill="none" aria-hidden="true">
              <path d="M16 2.5C8.55 2.5 2.5 8.55 2.5 16c0 2.38.62 4.62 1.7 6.57L2.5 29.5l7.12-1.64A13.43 13.43 0 0 0 16 29.5c7.45 0 13.5-6.05 13.5-13.5S23.45 2.5 16 2.5Z" stroke="#16a34a" stroke-width="2"/>
              <path d="M12.9 10.7c-.25-.55-.52-.56-.76-.57h-.65c-.2 0-.52.08-.79.4-.27.32-1.04 1.02-1.04 2.49 0 1.47 1.07 2.89 1.22 3.09.15.2 2.07 3.32 5.13 4.52 2.55 1 3.07.8 3.62.75.55-.05 1.78-.72 2.03-1.41.25-.69.25-1.28.18-1.41-.08-.13-.27-.2-.57-.35-.3-.15-1.78-.88-2.06-.98-.27-.1-.47-.15-.67.15-.2.3-.77.98-.94 1.18-.17.2-.35.22-.65.07-.3-.15-1.25-.46-2.38-1.46-.88-.78-1.47-1.75-1.64-2.05-.17-.3-.02-.46.13-.61.13-.13.3-.35.45-.52.15-.17.2-.3.3-.5.1-.2.05-.37-.03-.52-.08-.15-.75-1.87-1.03-2.52Z" fill="#16a34a"/>
            </svg>

            {% if row.reminder_sent %}
              <!-- Tilde celeste encima del logo -->
              <span class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M20 6L9 17l-5-5" stroke="#38bdf8" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
            {% endif %}
          </a>
        </div>
      </div>
    {% endif %}
  {% endfor %}
</div>

<script>
  const openBtn = document.getElementById("openCalendar");
  const calendar = document.getElementById("calendarContainer");

  const daysWithTurns = {{ days_with_turns | tojson }};
  let view = new Date("{{ selected_date }}");
  let selectedDate = "{{ selected_date }}";

  const monthNamesEs = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  const dayNames = ["DOMINGO","LUNES","MARTES","MIÉRCOLES","JUEVES","VIERNES","SÁBADO"];

function updateHeaderDate(dateStr) {
  const d = new Date(dateStr + "T00:00:00");
  document.getElementById("dayName").textContent = dayNames[d.getDay()];
  document.getElementById("dayDate").textContent =
    dateStr.split("-").reverse().join("/");
}

updateHeaderDate(selectedDate);


  openBtn.addEventListener("click", () => {
    calendar.classList.toggle("hidden");
    renderCalendar();
  });

  function renderCalendar() {
    const year = view.getFullYear();
    const month = view.getMonth();
    const first = new Date(year, month, 1);
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDayIndex = (first.getDay() + 6) % 7;

    let html = `
      <div class="rounded-2xl border border-zinc-800 bg-zinc-900/80 backdrop-blur-xl p-3">
        <div class="flex items-center justify-between mb-3">
          <button type="button" onclick="prevMonth()"
            class="px-3 py-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 text-zinc-200">◀</button>

          <div class="text-sm font-semibold text-zinc-100">${monthNamesEs[month]} ${year}</div>

          <button type="button" onclick="nextMonth()"
            class="px-3 py-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 text-zinc-200">▶</button>
        </div>

        <div class="grid grid-cols-7 gap-1 text-center text-[11px] mb-2 text-zinc-400">
          <div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>Sa</div><div>Do</div>
        </div>

        <div class="grid grid-cols-7 gap-1 text-sm">
    `;

    for (let i = 0; i < firstDayIndex; i++) html += `<div></div>`;

    for (let d = 1; d <= daysInMonth; d++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
      const hasTurns = daysWithTurns.includes(dateStr);
      const isSel = (selectedDate === dateStr);

      let cls = "relative py-2 rounded-xl hover:opacity-90 bg-zinc-800 text-zinc-200";
      let style = "";
      if (isSel) {
        cls = "relative py-2 rounded-xl text-zinc-900 font-semibold";
        style = "style=\"background: var(--gold);\"";
      }

      const dot = hasTurns ? `<span class="absolute bottom-1 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-green-500"></span>` : "";

      html += `
        <button type="button" ${style} class="${cls}" onclick="pickDate('${dateStr}')">
          ${d}
          ${dot}
        </button>
      `;
    }

    html += `</div></div>`;
    calendar.innerHTML = html;
  }

  window.prevMonth = function () {
    view = new Date(view.getFullYear(), view.getMonth() - 1, 1);
    renderCalendar();
  };

  window.nextMonth = function () {
    view = new Date(view.getFullYear(), view.getMonth() + 1, 1);
    renderCalendar();
  };

  window.pickDate = function (dateStr) {
    window.location.href = `/turnos?date_str=${dateStr}`;
  };
</script>

{% endblock %}
