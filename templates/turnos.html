{% extends "base.html" %}
{% block content %}

<div class="mb-4">
  <div class="text-zinc-400 text-[11px] tracking-widest mb-1">AGENDA</div>
  <div class="flex items-center justify-between gap-3">
    <div class="text-2xl font-semibold">Turnos</div>

    <a href="/turnos/nuevo?date_str={{ selected_date }}&time_str=&staff_id={{ staff_id }}&salon={{ salon }}"
       class="px-4 py-2 rounded-2xl font-bold text-zinc-900 text-sm"
       style="background: var(--gold);">
      + Agendar
    </a>
  </div>
</div>

<!-- STAFF + SALON -->
<div class="card p-3 mb-4 flex flex-wrap items-center justify-between gap-3">
  <div class="flex flex-wrap gap-2">
    {% for st in staffs %}
      <a class="pill {% if st.id == staff_id %}active{% endif %}"
         href="/turnos?date_str={{ selected_date }}&staff_id={{ st.id }}&salon={{ salon }}">
        {{ st.name }}
      </a>
    {% endfor %}
  </div>

  <div class="flex items-center gap-2">
    <div class="text-zinc-300 text-sm font-bold">SALÓN</div>
    <a class="pill {% if salon == 1 %}active{% endif %}"
       href="/turnos?date_str={{ selected_date }}&staff_id={{ staff_id }}&salon=1">1</a>
    <a class="pill {% if salon == 2 %}active{% endif %}"
       href="/turnos?date_str={{ selected_date }}&staff_id={{ staff_id }}&salon=2">2</a>
  </div>
</div>

<!-- DÍA + FECHA -->
<div class="card p-4 mb-4 flex items-center justify-between">
  <div class="font-extrabold text-xl">{{ selected_weekday }}</div>
  <div class="text-zinc-300 font-bold">{{ selected_date_label }}</div>
</div>

<!-- LISTA DE SLOTS -->
<div class="card overflow-hidden">
  {% for hhmm in slots %}
    {% set st = slot_state[hhmm] %}

    {% if st.kind == "FREE" %}
      <a href="/turnos/nuevo?date_str={{ selected_date }}&time_str={{ hhmm }}&staff_id={{ staff_id }}&salon={{ salon }}"
         class="block px-4 py-3 border-b border-zinc-800/70 hover:bg-white/5">
        <div class="flex items-center justify-between">
          <div class="font-bold">{{ hhmm }}</div>
          <div class="font-extrabold text-green-400">LIBRE</div>
        </div>
        <div class="text-xs text-zinc-400 mt-1">Disponible</div>
      </a>

    {% elif st.kind == "BLOCKED" %}
      <div class="px-4 py-3 border-b border-zinc-800/70 bg-white/2">
        <div class="flex items-center justify-between">
          <div class="font-bold">{{ hhmm }}</div>
          <div class="font-extrabold text-zinc-400">No disponible</div>
        </div>
        <div class="text-xs text-zinc-500 mt-1">
          Ocupado por turno de {{ st.owner_start }} a {{ st.owner_end }}
        </div>
      </div>

    {% elif st.kind == "APPT" %}
      {% set a = st.appt %}

      <div class="px-4 py-3 border-b border-zinc-800/70 hover:bg-white/5">
        <div class="flex items-start justify-between gap-3">

          <!-- Link a editar -->
          <a href="/turnos/{{ a.id }}/editar" class="block flex-1 min-w-0">
            <div class="font-bold">{{ hhmm }} · {{ a.client.name }}</div>
            <div class="text-sm mt-1">
              {% if a.specialty %}
                <span class="font-extrabold" style="color: {{ a.specialty.color_hex }}">{{ a.specialty.name }}</span>
              {% endif %}
              <span class="text-zinc-300"> · {{ a.duration_min }} min</span>
              {% if a.deposit_paid and a.deposit_amount %}
                <span class="text-zinc-300"> · Seña ${{ a.deposit_amount }}</span>
              {% endif %}
            </div>
          </a>

          <!-- WhatsApp REAL + estado enviado -->
          <button type="button"
                  class="wa-btn shrink-0 h-10 w-10 rounded-2xl border border-zinc-700 bg-black/30 flex items-center justify-center"
                  data-appt-id="{{ a.id }}"
                  data-wa-sent="{{ 1 if a.wa_sent else 0 }}"
                  aria-label="Enviar recordatorio por WhatsApp"
                  title="WhatsApp">
            <span class="wa-check" aria-hidden="true">✓</span>

            <!-- ícono WhatsApp (SVG) -->
            <svg width="20" height="20" viewBox="0 0 32 32" fill="none" aria-hidden="true">
              <path fill="currentColor" d="M19.11 17.27c-.29-.15-1.7-.84-1.96-.93-.26-.1-.45-.15-.64.15-.19.29-.74.93-.91 1.12-.17.19-.33.22-.62.07-.29-.15-1.22-.45-2.33-1.43-.86-.77-1.44-1.72-1.61-2.01-.17-.29-.02-.45.13-.59.13-.13.29-.33.43-.5.15-.17.19-.29.29-.48.1-.19.05-.36-.02-.5-.07-.15-.64-1.54-.88-2.11-.23-.55-.47-.47-.64-.48l-.55-.01c-.19 0-.5.07-.76.36-.26.29-1 1-1 2.43 0 1.43 1.03 2.81 1.17 3.01.15.19 2.03 3.1 4.92 4.35.69.3 1.22.48 1.64.61.69.22 1.31.19 1.81.12.55-.08 1.7-.69 1.94-1.36.24-.67.24-1.24.17-1.36-.07-.12-.26-.19-.55-.33z"/>
              <path fill="currentColor" d="M26.67 5.33C23.98 2.65 20.41 1.17 16.62 1.17 8.96 1.17 2.73 7.4 2.73 15.06c0 2.45.64 4.84 1.85 6.95L2.62 30.83l9-1.92c2.02 1.1 4.3 1.68 6.63 1.68h.01c7.66 0 13.89-6.23 13.89-13.89 0-3.79-1.48-7.36-4.16-10.04zm-10.04 22.4h-.01c-2.07 0-4.1-.56-5.87-1.62l-.42-.25-5.34 1.14 1.14-5.2-.28-.43c-1.18-1.83-1.81-3.95-1.81-6.14 0-6.31 5.13-11.44 11.45-11.44 3.06 0 5.94 1.19 8.1 3.35 2.16 2.16 3.35 5.04 3.35 8.1 0 6.31-5.13 11.45-11.44 11.45z"/>
            </svg>
          </button>

        </div>
      </div>
    {% endif %}
  {% endfor %}
</div>

<script>
  function setSentUI(btn, sent){
    btn.classList.toggle("is-sent", !!sent);
    if(sent){
      try { localStorage.setItem("wa_sent_" + btn.dataset.apptId, "1"); } catch(e){}
    }
  }

  function initSentButtons(){
    document.querySelectorAll(".wa-btn").forEach(btn => {
      const id = btn.dataset.apptId;
      const fromDb = btn.getAttribute("data-wa-sent") === "1";
      let fromLocal = false;
      try { fromLocal = localStorage.getItem("wa_sent_" + id) === "1"; } catch(e){}
      setSentUI(btn, fromDb || fromLocal);
    });
  }

  async function openWhatsAppForAppointment(btn){
    const apptId = btn.dataset.apptId;
    try{
      const res = await fetch(`/turnos/${apptId}/wa_link`, { headers: { "Accept": "application/json" }});
      if(!res.ok) throw new Error("No se pudo generar el link WA");
      const data = await res.json();
      if(!data || !data.url) throw new Error("Respuesta inválida del servidor");

      // Abrir WhatsApp
      window.open(data.url, "_blank");

      // Marcar UI inmediatamente (optimista)
      setSentUI(btn, true);

      // Guardar en DB (si falla, al menos queda marcado local)
      fetch(`/turnos/${apptId}/wa_sent`, { method: "POST" }).catch(()=>{});
    }catch(err){
      alert("No pude abrir WhatsApp. Revisá que el cliente tenga teléfono y probá de nuevo.");
    }
  }

  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".wa-btn");
    if(!btn) return;
    e.preventDefault();
    e.stopPropagation();
    openWhatsAppForAppointment(btn);
  });

  initSentButtons();
</script>

<style>
  /* default: verde WhatsApp */
  .wa-btn { color: #25D366; position: relative; }
  .wa-btn:active { transform: scale(0.98); }

  /* tilde: oculta por defecto */
  .wa-check{
    position:absolute;
    top:-6px;
    right:-6px;
    width:18px;
    height:18px;
    border-radius:999px;
    background:#2563eb;   /* azul */
    color:white;
    font-weight:900;
    font-size:12px;
    display:none;
    align-items:center;
    justify-content:center;
    line-height:18px;
    border:2px solid rgba(0,0,0,.6);
  }

  /* estado enviado: botón azul + tilde */
  .wa-btn.is-sent { color: #2563eb; border-color: rgba(37,99,235,.5); }
  .wa-btn.is-sent .wa-check { display:flex; }
</style>

{% endblock %}
